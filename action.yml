name: Toolbelt
description: Deploy patched VTEX toolbelt, cache for faster deployment, and do login.
author: VTEX

inputs:
  account:
    description: 'Account to use on login'
    required: true
  appKey:
    description: 'VTEX App Key to login'
    required: true
  appToken:
    description: 'VTEX App Token to login'
    required: true
  workspace:
    description: 'Workspace to start after login, default master'
    required: false
    default: master
  bin:
    description: 'Name to call this version of toolbelt'
    required: false
    default: vtex-e2e
  git:
    description: 'Source repository to clone (org/repo)'
    required: false
    default: vtex/toolbelt
  branch:
    description: 'Which branch to use on git'
    required: false
    default: master

runs:
  using: 'composite'
  steps:

    - name: Checkout VTEX Toolbelt
      uses: actions/checkout@v3
      with:
        repository: ${{ inputs.git }}
        ref: ${{ inputs.branch }}
        path: toolbelt

    - name: 'Set up Node.js'
      uses: actions/setup-node@v3
      with:
        node-version: 16
        cache: yarn
        cache-dependency-path: toolbelt/yarn.lock
      continue-on-error: true

    - name: Cache VTEX Toolbelt
      id: cache-toolbelt
      uses: actions/cache@v3
      with:
        path: |
          toolbelt
          /usr/local/bin/${{ inputs.bin }}
        key: ${{ runner.os }}-${{ inputs.git }}-${{ inputs.branch }}-${{ inputs.bin }}


    - name: Install VTEX Toolbelt
      if: steps.cache-toolbelt.outputs.cache-hit != 'true'
      run: |
        yarn install --frozen-lockfile
        yarn build
        cp bin/run bin/${{ inputs.bin }}
        ln -s $(pwd)/bin/${{ inputs.bin }} /usr/local/bin/
        ${{ inputs.bin }} whoami || echo "First call to warm it up"
        VERSION=$(${{ inputs.bin }} version)
        echo ::notice title=VTEX Toolbelt version::$VERSION
      working-directory: toolbelt
      shell: bash

    - run: |
        bash $GITHUB_ACTION_PATH/entrypoint.sh
      id: login
      shell: bash
      env:
        IN_CYPRESS: 'true'
        VTEX_BIN: ${{ inputs.bin }}
        VTEX_ACCOUNT: ${{ inputs.account }}
        VTEX_APP_KEY: ${{ inputs.appKey }}
        VTEX_APP_TOKEN: ${{ inputs.appToken }}
        VTEX_WORKSPACE: ${{ inputs.workspace }}
        VTEX_TOOLBELT_GIT: ${{ inputs.git }}
        VTEX_TOOLBELT_BRANCH: ${{ inputs.branch }}

branding:
  icon: activity
  color: yellow
